name: Build Manager with Manual Trigger

# 1. å®šä¹‰è§¦å‘äº‹ä»¶
on:
  # æ‰‹åŠ¨è§¦å‘äº‹ä»¶ï¼ˆæ ¸å¿ƒé…ç½®ï¼‰
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'è¦æ„å»ºçš„ä»£ç æ‰€åœ¨åˆ†æ”¯'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - dev
          - ci
      build_type:
        description: 'é€‰æ‹©æ„å»ºç±»å‹'
        required: true
        default: 'release'
        type: choice
        options:
          - debug
          - release
      enable_upload:
        description: 'æ˜¯å¦å¯ç”¨ä¸Šä¼ åŠŸèƒ½'
        required: false
        default: true
        type: boolean
      custom_message:
        description: 'è‡ªå®šä¹‰æ„å»ºä¿¡æ¯ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: 'ç”±æ‰‹åŠ¨è§¦å‘å‘èµ·çš„æ„å»º'
        type: string

  # ä¿ç•™ä½ åŸæœ‰çš„è‡ªåŠ¨è§¦å‘æ¡ä»¶ï¼ˆæ ¹æ®éœ€è¦ä¿ç•™æˆ–è°ƒæ•´ï¼‰
  push:
    branches: [ "main", "dev", "ci" ]
    paths:
      - '.github/workflows/build-manager.yml'
      - 'manager/**'
      - 'kernel/**'
  pull_request:
    branches: [ "main", "dev" ]
    paths-ignore:
      - '**.md'

# 2. å®šä¹‰å·¥ä½œæµä»»åŠ¡
jobs:
  build-manager:
    name: Build Manager - ${{ github.event.inputs.build_type || 'release' }}
    runs-on: ubuntu-latest
    
    # ä½¿ç”¨ç­–ç•¥çŸ©é˜µè¿›è¡Œå¤šç¯å¢ƒæ„å»ºï¼ˆå¯é€‰ï¼‰
    strategy:
      matrix:
        include:
          - target: aarch64-linux-android
            platform: android-arm64
          - target: x86_64-linux-android  
            platform: android-x64

    steps:
      # æ­¥éª¤1: æ˜¾ç¤ºæ„å»ºä¿¡æ¯
      - name: Display build parameters
        run: |
          echo "ğŸ¯ æ„å»ºåˆ†æ”¯: ${{ github.event.inputs.target_branch }}"
          echo "ğŸ”§ æ„å»ºç±»å‹: ${{ github.event.inputs.build_type }}"
          echo "ğŸ“¤ ä¸Šä¼ åŠŸèƒ½: ${{ github.event.inputs.enable_upload }}"
          echo "ğŸ’¬ è‡ªå®šä¹‰ä¿¡æ¯: ${{ github.event.inputs.custom_message }}"
          echo "ğŸ–¥ï¸  æ„å»ºç›®æ ‡: ${{ matrix.target }} (${{ matrix.platform }})"

      # æ­¥éª¤2: æ£€å‡ºä»£ç ï¼ˆåˆ‡æ¢åˆ°æ‰‹åŠ¨è§¦å‘æ—¶æŒ‡å®šçš„åˆ†æ”¯ï¼‰
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_branch }}

      # æ­¥éª¤3: è®¾ç½®æ„å»ºç¯å¢ƒï¼ˆæ ¹æ®ä½ çš„é¡¹ç›®éœ€è¦ï¼‰
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # æ­¥éª¤4: æ ¹æ®æ„å»ºç±»å‹æ‰§è¡Œä¸åŒæ“ä½œ
      - name: Build application
        run: |
          # æ ¹æ®æ‰‹åŠ¨é€‰æ‹©çš„æ„å»ºç±»å‹æ‰§è¡Œä¸åŒå‘½ä»¤
          if [ "${{ github.event.inputs.build_type }}" = "release" ]; then
            echo "æ‰§è¡ŒReleaseæ„å»º..."
            # ä½ çš„Releaseæ„å»ºå‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
            # ./gradlew assembleRelease
          else
            echo "æ‰§è¡ŒDebugæ„å»º..."
            # ä½ çš„Debugæ„å»ºå‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
            # ./gradlew assembleDebug
          fi

      # æ­¥éª¤5: æ¡ä»¶æ€§ä¸Šä¼ ï¼ˆæ ¹æ®å¸ƒå°”å€¼è¾“å…¥å†³å®šï¼‰
      - name: Upload artifacts
        if: github.event.inputs.enable_upload == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.platform }}-${{ github.event.inputs.build_type }}
          path: |
            app/build/outputs/**/*.apk
            !**/*-unaligned.apk

      # æ­¥éª¤6: å‘é€é€šçŸ¥ï¼ˆåŒ…å«è‡ªå®šä¹‰æ¶ˆæ¯ï¼‰
      - name: Send notification
        if: always() && github.event.inputs.custom_message != ''
        run: |
          echo "æ„å»ºå®Œæˆ: ${{ github.event.inputs.custom_message }}"
          # è¿™é‡Œå¯ä»¥é›†æˆé‚®ä»¶ã€Slackã€é’‰é’‰ç­‰é€šçŸ¥æ–¹å¼
